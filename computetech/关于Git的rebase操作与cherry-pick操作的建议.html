<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>关于Git的rebase操作与cherry-pick操作的建议 | 林中路</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="缘起
最近一次新疆采编发版时，发现代码中有一处配置的一个变量没有了，经过查询Git的提交历史发现这次改动涉及的提交bbb的作者是开发人员A，但A君表示从来没有动过这块代码。
这就很奇怪了，明明Git上显示的作者是A君，但A又表示不是自己改的，那到底是Git在说谎还是A君在说谎？
经过线下询问其他采编开发人员，并对比Git的分支图谱，多方查证，终于弄清楚了原因： ...">
    
    <link rel="preload" href="/assets/css/0.styles.6d0d6f13.css" as="style"><link rel="preload" href="/assets/js/app.cd8205c8.js" as="script"><link rel="preload" href="/assets/js/11.4c288b74.js" as="script"><link rel="preload" href="/assets/js/29.841b64b0.js" as="script"><link rel="prefetch" href="/assets/js/1.c492b4cd.js"><link rel="prefetch" href="/assets/js/10.5c791580.js"><link rel="prefetch" href="/assets/js/100.98ff7760.js"><link rel="prefetch" href="/assets/js/101.e5cd16d7.js"><link rel="prefetch" href="/assets/js/102.cc9bc85b.js"><link rel="prefetch" href="/assets/js/103.7b07b598.js"><link rel="prefetch" href="/assets/js/104.ee58d457.js"><link rel="prefetch" href="/assets/js/105.48c57f25.js"><link rel="prefetch" href="/assets/js/106.b702757c.js"><link rel="prefetch" href="/assets/js/107.8122f1ef.js"><link rel="prefetch" href="/assets/js/108.51e66dbe.js"><link rel="prefetch" href="/assets/js/109.3145253b.js"><link rel="prefetch" href="/assets/js/110.f9990065.js"><link rel="prefetch" href="/assets/js/111.3263bd3f.js"><link rel="prefetch" href="/assets/js/112.9071b5e2.js"><link rel="prefetch" href="/assets/js/113.f131242e.js"><link rel="prefetch" href="/assets/js/114.7a6e09f7.js"><link rel="prefetch" href="/assets/js/115.508d99ac.js"><link rel="prefetch" href="/assets/js/116.f4900a92.js"><link rel="prefetch" href="/assets/js/117.e5957144.js"><link rel="prefetch" href="/assets/js/118.062eb3c1.js"><link rel="prefetch" href="/assets/js/119.93634bcc.js"><link rel="prefetch" href="/assets/js/12.c3b16095.js"><link rel="prefetch" href="/assets/js/120.1bada0ab.js"><link rel="prefetch" href="/assets/js/121.7d55e294.js"><link rel="prefetch" href="/assets/js/122.b7f7c837.js"><link rel="prefetch" href="/assets/js/123.3a0b4694.js"><link rel="prefetch" href="/assets/js/124.bd458b77.js"><link rel="prefetch" href="/assets/js/125.8ca612c9.js"><link rel="prefetch" href="/assets/js/126.35bccb3e.js"><link rel="prefetch" href="/assets/js/127.9b3097f5.js"><link rel="prefetch" href="/assets/js/128.5833cf40.js"><link rel="prefetch" href="/assets/js/129.38ec9907.js"><link rel="prefetch" href="/assets/js/13.91404f5a.js"><link rel="prefetch" href="/assets/js/130.932a54c4.js"><link rel="prefetch" href="/assets/js/131.f4ab894a.js"><link rel="prefetch" href="/assets/js/14.ef93462f.js"><link rel="prefetch" href="/assets/js/15.83829c35.js"><link rel="prefetch" href="/assets/js/16.d245c760.js"><link rel="prefetch" href="/assets/js/17.4a9f3c99.js"><link rel="prefetch" href="/assets/js/18.75ce45c7.js"><link rel="prefetch" href="/assets/js/19.b86d35ae.js"><link rel="prefetch" href="/assets/js/20.9657eb2e.js"><link rel="prefetch" href="/assets/js/21.f89cf353.js"><link rel="prefetch" href="/assets/js/22.746aec5f.js"><link rel="prefetch" href="/assets/js/23.ca2ee980.js"><link rel="prefetch" href="/assets/js/24.e1eeb0f4.js"><link rel="prefetch" href="/assets/js/25.f96e0147.js"><link rel="prefetch" href="/assets/js/26.cc4cf83e.js"><link rel="prefetch" href="/assets/js/27.f940e542.js"><link rel="prefetch" href="/assets/js/28.99771a3c.js"><link rel="prefetch" href="/assets/js/30.772e1ff4.js"><link rel="prefetch" href="/assets/js/31.7e0b62c5.js"><link rel="prefetch" href="/assets/js/32.cf3d5fb6.js"><link rel="prefetch" href="/assets/js/33.b338e29a.js"><link rel="prefetch" href="/assets/js/34.8b8356fe.js"><link rel="prefetch" href="/assets/js/35.1b12a1f7.js"><link rel="prefetch" href="/assets/js/36.547e2f8d.js"><link rel="prefetch" href="/assets/js/37.36a240bd.js"><link rel="prefetch" href="/assets/js/38.4f6b92e3.js"><link rel="prefetch" href="/assets/js/39.5133d0dd.js"><link rel="prefetch" href="/assets/js/4.524efd0b.js"><link rel="prefetch" href="/assets/js/40.8c765af6.js"><link rel="prefetch" href="/assets/js/41.b7234e21.js"><link rel="prefetch" href="/assets/js/42.b5ac212a.js"><link rel="prefetch" href="/assets/js/43.5d1b3b6c.js"><link rel="prefetch" href="/assets/js/44.eda633f8.js"><link rel="prefetch" href="/assets/js/45.39f5263b.js"><link rel="prefetch" href="/assets/js/46.f1fbfada.js"><link rel="prefetch" href="/assets/js/47.ed969447.js"><link rel="prefetch" href="/assets/js/48.e1867366.js"><link rel="prefetch" href="/assets/js/49.c2a4bc6b.js"><link rel="prefetch" href="/assets/js/5.a180cf14.js"><link rel="prefetch" href="/assets/js/50.da77d6a3.js"><link rel="prefetch" href="/assets/js/51.4183e6ab.js"><link rel="prefetch" href="/assets/js/52.b18add11.js"><link rel="prefetch" href="/assets/js/53.08c1d448.js"><link rel="prefetch" href="/assets/js/54.9edeb19b.js"><link rel="prefetch" href="/assets/js/55.9a3ed63e.js"><link rel="prefetch" href="/assets/js/56.dcf34dca.js"><link rel="prefetch" href="/assets/js/57.2123aa49.js"><link rel="prefetch" href="/assets/js/58.c9833b3b.js"><link rel="prefetch" href="/assets/js/59.8da7c174.js"><link rel="prefetch" href="/assets/js/6.529edc8a.js"><link rel="prefetch" href="/assets/js/60.9a70415e.js"><link rel="prefetch" href="/assets/js/61.35935df8.js"><link rel="prefetch" href="/assets/js/62.0e63cfe7.js"><link rel="prefetch" href="/assets/js/63.a52d5a72.js"><link rel="prefetch" href="/assets/js/64.cf7dfcc7.js"><link rel="prefetch" href="/assets/js/65.0220a5ee.js"><link rel="prefetch" href="/assets/js/66.5cd774f3.js"><link rel="prefetch" href="/assets/js/67.d8943555.js"><link rel="prefetch" href="/assets/js/68.7cf24f78.js"><link rel="prefetch" href="/assets/js/69.56501738.js"><link rel="prefetch" href="/assets/js/7.ac95b826.js"><link rel="prefetch" href="/assets/js/70.9626260f.js"><link rel="prefetch" href="/assets/js/71.a466c6f1.js"><link rel="prefetch" href="/assets/js/72.0a678f77.js"><link rel="prefetch" href="/assets/js/73.597ea695.js"><link rel="prefetch" href="/assets/js/74.a0387d5c.js"><link rel="prefetch" href="/assets/js/75.97871f2e.js"><link rel="prefetch" href="/assets/js/76.7d8e44c7.js"><link rel="prefetch" href="/assets/js/77.b53c8e31.js"><link rel="prefetch" href="/assets/js/78.9fef1461.js"><link rel="prefetch" href="/assets/js/79.9af76496.js"><link rel="prefetch" href="/assets/js/8.6bb76bea.js"><link rel="prefetch" href="/assets/js/80.5f7ee3db.js"><link rel="prefetch" href="/assets/js/81.1937e784.js"><link rel="prefetch" href="/assets/js/82.2bdeb675.js"><link rel="prefetch" href="/assets/js/83.e04a8620.js"><link rel="prefetch" href="/assets/js/84.ca8713d0.js"><link rel="prefetch" href="/assets/js/85.40f655ff.js"><link rel="prefetch" href="/assets/js/86.87397155.js"><link rel="prefetch" href="/assets/js/87.798cdf26.js"><link rel="prefetch" href="/assets/js/88.e089f692.js"><link rel="prefetch" href="/assets/js/89.5d842e18.js"><link rel="prefetch" href="/assets/js/9.5b2ac283.js"><link rel="prefetch" href="/assets/js/90.4157be98.js"><link rel="prefetch" href="/assets/js/91.7ed6afe7.js"><link rel="prefetch" href="/assets/js/92.9c50ce3b.js"><link rel="prefetch" href="/assets/js/93.e8e16a70.js"><link rel="prefetch" href="/assets/js/94.cf98a377.js"><link rel="prefetch" href="/assets/js/95.a4b78938.js"><link rel="prefetch" href="/assets/js/96.a7a9f018.js"><link rel="prefetch" href="/assets/js/97.f96c42c9.js"><link rel="prefetch" href="/assets/js/98.ce7378e5.js"><link rel="prefetch" href="/assets/js/99.24959418.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.706cf0ce.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6d0d6f13.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="header"><div class="blog-info" data-v-54e0dde5>
   林中路
   <p data-v-54e0dde5>少有人走的路，逐渐向世界显现</p></div> <div class="blog-author-info" data-v-51bc2051><p class="author-head-img" data-v-51bc2051><img src="/assets/img/head-img.8e2d0100.png" alt data-v-51bc2051></p></div> <div class="blog-category-list" data-v-581efa6b><ul data-v-581efa6b></ul></div></div> <div class="content"><div class="template-container" data-v-b70586ba><div class="content" data-v-b70586ba><div class="content__default" data-v-b70586ba><h1 id="关于git的rebase操作与cherry-pick操作的建议"><a href="#关于git的rebase操作与cherry-pick操作的建议" class="header-anchor">#</a> 关于Git的<code>rebase</code>操作与<code>cherry-pick</code>操作的建议</h1> <h2 id="缘起"><a href="#缘起" class="header-anchor">#</a> 缘起</h2> <p>最近一次新疆采编发版时，发现代码中有一处配置的一个变量没有了，经过查询Git的提交历史发现这次改动涉及的提交<code>bbb</code>的作者是开发人员A，但A君表示从来没有动过这块代码。</p> <p>这就很奇怪了，明明Git上显示的作者是A君，但A又表示不是自己改的，那到底是Git在说谎还是A君在说谎？</p> <p>经过线下询问其他采编开发人员，并对比Git的分支图谱，多方查证，终于弄清楚了原因：</p> <ol><li>开发人员B君要开发的一个功能正好在产品分支上已经有了，所以采用了<code>cherry-pick</code>的方式从产品分支将这个功能的那次提交<code>000</code>(作者是D，提交者是A)从产品分支复制到了新疆开发分支1上面。复制时产生了冲突，B君解决了冲突，进行了提交<code>aaa</code>。</li> <li>在解决冲突的过程中，由于那个丢失的变量在产品分支上没有，而在新疆分支上有，但是那个变量上面便是要从产品分支上复制过来的代码，所以B君直接通过工具采用了产品分支的代码，导致新疆分支上有的那个变量被产品分支代码所替换而丢失。</li> <li>B君继续在开发分支1上进行了其它功能的开发，进行了两次提交，然后提了<code>MR</code>给C君，请求将开发分支1合并到主开发分支0上面。</li> <li>这时D君说，不用合并了，他要直接<code>rebase</code>，所以C君关闭了<code>MR</code>，而D君使用<code>rebase</code>命令直接将开发分支1上的这几次提交复制到了主开发分支0上，复制后提交<code>aaa</code>变为了提交<code>bbb</code>。</li></ol> <p>然后就是后来，我们开头说的，发版时发现了变量丢失的问题。</p> <p>这个过程中，我们产生过两个疑问：</p> <ol><li>我们通过历史提交查询的时候为什么没有查询到提交<code>aaa</code>？</li> <li>为什么提交<code>bbb</code>的作者不是B君而是A君。</li></ol> <h2 id="破案"><a href="#破案" class="header-anchor">#</a> 破案</h2> <p>解决这两个问题，我们先要弄清楚：</p> <p>当我们查看提交历史的时候，所显示的<code>Author</code>（作者）真的就是这次提交中那些文件的真正改动者吗？</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">git</span> log
commit af7af21595aba7d6ac02b34c3a852ed267a395b7 <span class="token punctuation">(</span>HEAD -<span class="token operator">&gt;</span> master, origin/master, origin/HEAD<span class="token punctuation">)</span>
Author: chen.chen <span class="token operator">&lt;</span>chenchen@trs.com.cn<span class="token operator">&gt;</span>
Date:   Thu Aug <span class="token number">5</span> <span class="token number">17</span>:55:12 <span class="token number">2021</span> +0800

    修复全部栏目检索问题
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>首先，我们应该知道，Git中所谓的【提交】在底层实现上就是一个二进制对象，它存储在<code>.git/objects</code>目录下。</p> <p>就比如上例中<code>af7af21</code>这次提交，其实指向的是<code>.git/objects/af/7af21595aba7d6ac02b34c3a852ed267a395b7</code>这个二进制对象，我们可以通过Git的底层命令来查看一下这个二进制对象的内容：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">git</span> cat-file -p af7af21
tree 3ab963b8fca3658404126787e075b4d4dbdfc697
parent ab8c90a1ca8544802c3e00b2ea5ccaf01d20976b
author chen.chen <span class="token operator">&lt;</span>chenchen@trs.com.cn<span class="token operator">&gt;</span> <span class="token number">1628157312</span> +0800   
committer chen.chen <span class="token operator">&lt;</span>chenchen@trs.com.cn<span class="token operator">&gt;</span> <span class="token number">1628157312</span> +0800

修复全部栏目检索问题
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到，这个提交对象了有两个和人员有关的属性：</p> <ul><li><code>author</code>：代表这次提交所涉及的更改真正的作者</li> <li><code>committer</code>： 创建这个提交的人。</li></ul> <p>从这一点来看，一般情况下，提交都是由作者进行的，那作者和提交者应该是同一个人。</p> <p>但是，总有不一般的情况，就比如：</p> <ol><li><code>cherry-pick</code>操作：A将另一个分支上的提交<code>a</code>复制到自己的分支时，会在当前分支上重新产生一个新的提交<code>b</code>，这个提交<code>b</code>的内容和提交<code>a</code>的内容一模一样，但是提交<code>a</code>的提交者将变成提交<code>b</code>的作者，而A将成为提交<code>a</code>的提交者。</li> <li><code>rebase</code>操作： 当A将另一个分支上的提交通过<code>rebase</code>复制到自己分支时，那个提交的作者不变，但提交者将由原来的提交者变为A。</li> <li><code>MR</code> 操作：A在一个分支上进行了提交若干次提交后，发送了一个<code>MR</code>请求给B，B在合并时勾选了<code>合并提交</code>选项，这时A做的若干次提交将被合并为一个新的提交（相当于<code>rebase -i</code>操作），此时，这个新的提交的作者是A，提交者是B。</li></ol> <p>而在本文开头所述那次事故，正好就是踩了这几个坑，我们来梳理一下整个过程：</p> <ol><li>C君在产品分支1上开发了若干功能（其中就包含B君要的那个），进行了提交，发送了一个<code>MR</code>请求给A君，A君勾选了【合并提交】选项后将产品分支1合并入了产品分支。此时D君做的所有提交被合并后生成了一个新的提交<code>000</code>，这个提交的作者是C，提交者是A。</li> <li>B君在新疆开发分支1上进行了<code>cherry-pick</code>，将<code>000</code>分支复制到了开发分支1，解决冲突后提交，生成了提交<code>aaa</code>，此时<code>aaa</code>提交的作者是A，提交者是B。</li> <li>D君使用了<code>rebase</code>操作将<code>aaa</code>从开发分支1复制到了开发分支0上，此时开发分支0上产生了提交<code>bbb</code>,这个提交的作者还是A，但提交者变成了D。</li></ol> <p>当发现代码问题时，我们顺着开发分支0的提交历史去看，自然看到的作者是A。</p> <p>所以，Git没有说谎，A也没有说谎，这是一场由A、B、C、D共同参与的【无心的共谋】。</p> <h2 id="教训"><a href="#教训" class="header-anchor">#</a> 教训</h2> <p>这次事故的原因找到后，我们从中应该学到一些东西。</p> <ol><li><code>rebase</code>合并提交操作会重写提交历史。（<code>MR</code>时的合并提交其实就是<code>rebase -i</code>）</li> <li><code>rebase</code>复制提交操作后，提交历史无法反映提交来源自哪个分支以及被复制提交的原始信息</li> <li><code>cherry-pick</code>复制提交操作后，提交历史无法反映提交来源自哪个分支以及被复制提交的原始信息，并且无法真实反映被复制提交原来的作者信息。（当被复制提交作者与提交者不同时）</li></ol> <p>这些特性的存在，会严重影响代码出问题时的溯源工作。</p> <p>所以，这里做出如下建议，供大家讨论决定：</p> <ol><li><code>rebase</code>操作不允许应用在共享分支上。（可以在自己的私有分支间随便折腾）</li> <li><code>cherry-pick</code>操作必须记录到单独日志文件里，注明原始分支和提交的相关信息。</li></ol> <p>·</p></div></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cd8205c8.js" defer></script><script src="/assets/js/11.4c288b74.js" defer></script><script src="/assets/js/29.841b64b0.js" defer></script>
  </body>
</html>
