<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ueditor源码分析——编辑器初始化流程 | 林中路</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="
全局对象

ueditor 全局顶级的 UE 对象，并挂载在了window 对象上

var baidu = window.baidu || {};

window.baidu = baidu;

window.UE = baidu.editor = window.UE || {};

在顶级 UE 对象上，又挂载了一些顶级模块，分别是 ...">
    
    <link rel="preload" href="/assets/css/0.styles.6d0d6f13.css" as="style"><link rel="preload" href="/assets/js/app.cd8205c8.js" as="script"><link rel="preload" href="/assets/js/11.4c288b74.js" as="script"><link rel="preload" href="/assets/js/117.e5957144.js" as="script"><link rel="prefetch" href="/assets/js/1.c492b4cd.js"><link rel="prefetch" href="/assets/js/10.5c791580.js"><link rel="prefetch" href="/assets/js/100.98ff7760.js"><link rel="prefetch" href="/assets/js/101.e5cd16d7.js"><link rel="prefetch" href="/assets/js/102.cc9bc85b.js"><link rel="prefetch" href="/assets/js/103.7b07b598.js"><link rel="prefetch" href="/assets/js/104.ee58d457.js"><link rel="prefetch" href="/assets/js/105.48c57f25.js"><link rel="prefetch" href="/assets/js/106.b702757c.js"><link rel="prefetch" href="/assets/js/107.8122f1ef.js"><link rel="prefetch" href="/assets/js/108.51e66dbe.js"><link rel="prefetch" href="/assets/js/109.3145253b.js"><link rel="prefetch" href="/assets/js/110.f9990065.js"><link rel="prefetch" href="/assets/js/111.3263bd3f.js"><link rel="prefetch" href="/assets/js/112.9071b5e2.js"><link rel="prefetch" href="/assets/js/113.f131242e.js"><link rel="prefetch" href="/assets/js/114.7a6e09f7.js"><link rel="prefetch" href="/assets/js/115.508d99ac.js"><link rel="prefetch" href="/assets/js/116.f4900a92.js"><link rel="prefetch" href="/assets/js/118.062eb3c1.js"><link rel="prefetch" href="/assets/js/119.93634bcc.js"><link rel="prefetch" href="/assets/js/12.c3b16095.js"><link rel="prefetch" href="/assets/js/120.1bada0ab.js"><link rel="prefetch" href="/assets/js/121.7d55e294.js"><link rel="prefetch" href="/assets/js/122.b7f7c837.js"><link rel="prefetch" href="/assets/js/123.3a0b4694.js"><link rel="prefetch" href="/assets/js/124.bd458b77.js"><link rel="prefetch" href="/assets/js/125.8ca612c9.js"><link rel="prefetch" href="/assets/js/126.35bccb3e.js"><link rel="prefetch" href="/assets/js/127.9b3097f5.js"><link rel="prefetch" href="/assets/js/128.5833cf40.js"><link rel="prefetch" href="/assets/js/129.38ec9907.js"><link rel="prefetch" href="/assets/js/13.91404f5a.js"><link rel="prefetch" href="/assets/js/130.932a54c4.js"><link rel="prefetch" href="/assets/js/131.f4ab894a.js"><link rel="prefetch" href="/assets/js/14.ef93462f.js"><link rel="prefetch" href="/assets/js/15.83829c35.js"><link rel="prefetch" href="/assets/js/16.d245c760.js"><link rel="prefetch" href="/assets/js/17.4a9f3c99.js"><link rel="prefetch" href="/assets/js/18.75ce45c7.js"><link rel="prefetch" href="/assets/js/19.b86d35ae.js"><link rel="prefetch" href="/assets/js/20.9657eb2e.js"><link rel="prefetch" href="/assets/js/21.f89cf353.js"><link rel="prefetch" href="/assets/js/22.746aec5f.js"><link rel="prefetch" href="/assets/js/23.ca2ee980.js"><link rel="prefetch" href="/assets/js/24.e1eeb0f4.js"><link rel="prefetch" href="/assets/js/25.f96e0147.js"><link rel="prefetch" href="/assets/js/26.cc4cf83e.js"><link rel="prefetch" href="/assets/js/27.f940e542.js"><link rel="prefetch" href="/assets/js/28.99771a3c.js"><link rel="prefetch" href="/assets/js/29.841b64b0.js"><link rel="prefetch" href="/assets/js/30.772e1ff4.js"><link rel="prefetch" href="/assets/js/31.7e0b62c5.js"><link rel="prefetch" href="/assets/js/32.cf3d5fb6.js"><link rel="prefetch" href="/assets/js/33.b338e29a.js"><link rel="prefetch" href="/assets/js/34.8b8356fe.js"><link rel="prefetch" href="/assets/js/35.1b12a1f7.js"><link rel="prefetch" href="/assets/js/36.547e2f8d.js"><link rel="prefetch" href="/assets/js/37.36a240bd.js"><link rel="prefetch" href="/assets/js/38.4f6b92e3.js"><link rel="prefetch" href="/assets/js/39.5133d0dd.js"><link rel="prefetch" href="/assets/js/4.524efd0b.js"><link rel="prefetch" href="/assets/js/40.8c765af6.js"><link rel="prefetch" href="/assets/js/41.b7234e21.js"><link rel="prefetch" href="/assets/js/42.b5ac212a.js"><link rel="prefetch" href="/assets/js/43.5d1b3b6c.js"><link rel="prefetch" href="/assets/js/44.eda633f8.js"><link rel="prefetch" href="/assets/js/45.39f5263b.js"><link rel="prefetch" href="/assets/js/46.f1fbfada.js"><link rel="prefetch" href="/assets/js/47.ed969447.js"><link rel="prefetch" href="/assets/js/48.e1867366.js"><link rel="prefetch" href="/assets/js/49.c2a4bc6b.js"><link rel="prefetch" href="/assets/js/5.a180cf14.js"><link rel="prefetch" href="/assets/js/50.da77d6a3.js"><link rel="prefetch" href="/assets/js/51.4183e6ab.js"><link rel="prefetch" href="/assets/js/52.b18add11.js"><link rel="prefetch" href="/assets/js/53.08c1d448.js"><link rel="prefetch" href="/assets/js/54.9edeb19b.js"><link rel="prefetch" href="/assets/js/55.9a3ed63e.js"><link rel="prefetch" href="/assets/js/56.dcf34dca.js"><link rel="prefetch" href="/assets/js/57.2123aa49.js"><link rel="prefetch" href="/assets/js/58.c9833b3b.js"><link rel="prefetch" href="/assets/js/59.8da7c174.js"><link rel="prefetch" href="/assets/js/6.529edc8a.js"><link rel="prefetch" href="/assets/js/60.9a70415e.js"><link rel="prefetch" href="/assets/js/61.35935df8.js"><link rel="prefetch" href="/assets/js/62.0e63cfe7.js"><link rel="prefetch" href="/assets/js/63.a52d5a72.js"><link rel="prefetch" href="/assets/js/64.cf7dfcc7.js"><link rel="prefetch" href="/assets/js/65.0220a5ee.js"><link rel="prefetch" href="/assets/js/66.5cd774f3.js"><link rel="prefetch" href="/assets/js/67.d8943555.js"><link rel="prefetch" href="/assets/js/68.7cf24f78.js"><link rel="prefetch" href="/assets/js/69.56501738.js"><link rel="prefetch" href="/assets/js/7.ac95b826.js"><link rel="prefetch" href="/assets/js/70.9626260f.js"><link rel="prefetch" href="/assets/js/71.a466c6f1.js"><link rel="prefetch" href="/assets/js/72.0a678f77.js"><link rel="prefetch" href="/assets/js/73.597ea695.js"><link rel="prefetch" href="/assets/js/74.a0387d5c.js"><link rel="prefetch" href="/assets/js/75.97871f2e.js"><link rel="prefetch" href="/assets/js/76.7d8e44c7.js"><link rel="prefetch" href="/assets/js/77.b53c8e31.js"><link rel="prefetch" href="/assets/js/78.9fef1461.js"><link rel="prefetch" href="/assets/js/79.9af76496.js"><link rel="prefetch" href="/assets/js/8.6bb76bea.js"><link rel="prefetch" href="/assets/js/80.5f7ee3db.js"><link rel="prefetch" href="/assets/js/81.1937e784.js"><link rel="prefetch" href="/assets/js/82.2bdeb675.js"><link rel="prefetch" href="/assets/js/83.e04a8620.js"><link rel="prefetch" href="/assets/js/84.ca8713d0.js"><link rel="prefetch" href="/assets/js/85.40f655ff.js"><link rel="prefetch" href="/assets/js/86.87397155.js"><link rel="prefetch" href="/assets/js/87.798cdf26.js"><link rel="prefetch" href="/assets/js/88.e089f692.js"><link rel="prefetch" href="/assets/js/89.5d842e18.js"><link rel="prefetch" href="/assets/js/9.5b2ac283.js"><link rel="prefetch" href="/assets/js/90.4157be98.js"><link rel="prefetch" href="/assets/js/91.7ed6afe7.js"><link rel="prefetch" href="/assets/js/92.9c50ce3b.js"><link rel="prefetch" href="/assets/js/93.e8e16a70.js"><link rel="prefetch" href="/assets/js/94.cf98a377.js"><link rel="prefetch" href="/assets/js/95.a4b78938.js"><link rel="prefetch" href="/assets/js/96.a7a9f018.js"><link rel="prefetch" href="/assets/js/97.f96c42c9.js"><link rel="prefetch" href="/assets/js/98.ce7378e5.js"><link rel="prefetch" href="/assets/js/99.24959418.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.706cf0ce.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6d0d6f13.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="header"><div class="blog-info" data-v-54e0dde5>
   林中路
   <p data-v-54e0dde5>少有人走的路，逐渐向世界显现</p></div> <div class="blog-author-info" data-v-51bc2051><p class="author-head-img" data-v-51bc2051><img src="/assets/img/head-img.8e2d0100.png" alt data-v-51bc2051></p></div> <div class="blog-category-list" data-v-581efa6b><ul data-v-581efa6b></ul></div></div> <div class="content"><div class="template-container" data-v-b70586ba><div class="content" data-v-b70586ba><div class="content__default" data-v-b70586ba><h1 id="ueditor源码分析-编辑器初始化流程"><a href="#ueditor源码分析-编辑器初始化流程" class="header-anchor">#</a> ueditor源码分析——编辑器初始化流程</h1> <h2 id="全局对象"><a href="#全局对象" class="header-anchor">#</a> 全局对象</h2> <p><code>ueditor</code> 全局顶级的 <code>UE</code> 对象，并挂载在了<code>window</code> 对象上</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> baidu <span class="token operator">=</span> window<span class="token punctuation">.</span>baidu <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span>baidu <span class="token operator">=</span> baidu<span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token constant">UE</span> <span class="token operator">=</span> baidu<span class="token punctuation">.</span>editor <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">UE</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在顶级 <code>UE</code> 对象上，又挂载了一些顶级模块，分别是：</p> <ul><li><code>UE.plugins</code> :  编辑器的插件对象，以键值对的形式存储所有插件</li> <li><code>UE.commands</code>: 编辑器里的命令对象，以键值对形式存放编辑器命令</li> <li><code>UE.instants</code> : 编辑器实例对象，存储所有编辑器实例，可以支持多实例同时运行</li> <li><code>UE.I18N</code> : 编辑器的多语言支持对象</li> <li><code>UE._customizeUI</code>: 自定义<code>UI</code>组件对象，存储用户自定义的编辑器<code>UI</code>组件（包括弹窗、按钮等）</li> <li><code>UE.version</code> : 当前的<code>UE</code> 版本</li> <li><code>UE.dom</code> :  <code>UE</code>的核心类——<code>dom</code>操作类，类似<code>microsoft office word</code>的操作主要就是借助这个类实现的</li> <li><code>UE.browser</code> : 浏览器检测工具，可以检测浏览器内核和版本，在实现浏览器兼容的时候有用</li> <li><code>UE.Editor</code>:  <code>UE</code>的核心类，为用户提供与编辑器交互的接口</li> <li><code>UE.EventBase</code> ：<code>UE</code>的事件基类，主要用来注册监听事件，移除监听，触发事件等。</li> <li><code>UE.uNode</code> :  编辑器模拟的节点类，在二次开发时非常有用，可以对编辑器中的内容进行节点级操作。</li> <li><code>UE.ajax</code>: 请求工具类，用于异步场景，如文件上传等。</li> <li><code>UE.utils</code>: 系统工具包，主要是一些常用工具方法是封装，为了减少依赖，没有使用<code>jquery</code>或<code>underscore</code>等库提供的工具，而是自己实现了一套。</li> <li><code>UE.ui</code>: 私有工具方法，不对外暴露，主要提供界面创建功能。</li></ul> <h2 id="流程概览"><a href="#流程概览" class="header-anchor">#</a> 流程概览</h2> <p><img src="https://cdn.jsdelivr.net/gh/hjb2722404/myimg/20210610152553.png" alt="编辑器初始化流程图"></p> <h2 id="全局入口"><a href="#全局入口" class="header-anchor">#</a> 全局入口</h2> <p>从官方文档可知，<code>UE</code>的入口其实就是构造了一个 <code>Editor</code>对象:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span><span class="token operator">&gt;</span>
        <span class="token keyword">var</span> ue <span class="token operator">=</span> <span class="token constant">UE</span><span class="token punctuation">.</span><span class="token function">getEditor</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们看下<code>UE.getEditor</code> 的实现：</p> <h5 id="ueditor-all-js-在接近文件末尾的地方"><a href="#ueditor-all-js-在接近文件末尾的地方" class="header-anchor">#</a> <code>ueditor.all.js</code>  在接近文件末尾的地方：</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//...</span>
<span class="token constant">UE</span><span class="token punctuation">.</span><span class="token function-variable function">getEditor</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> opt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> editor <span class="token operator">=</span> instances<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                editor <span class="token operator">=</span> instances<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UE<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>Editor</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                editor<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> editor<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这是获取编辑器实例的方法，它接受两个参数:</p> <ul><li><code>id</code> : 编辑器的容器ID</li> <li><code>opt</code>: 编辑器配置，具体配置说明可查看  <a href="http://fex.baidu.com/ueditor/%5B%5Bstart-config%5D%5D" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>这个方法会检查在编辑器实例存储对象（<code>instances</code>）中，是否已经有了同ID的编辑器实例，如果有，则返回，如果没有，则调用<code>UE.ui.Editor</code> 方法新建一个实例，并且将该实例渲染到ID所指定的容器中。</p> <h3 id="初始化编辑器界面"><a href="#初始化编辑器界面" class="header-anchor">#</a> 初始化编辑器界面</h3> <p>我们来看下 <code>UE.ui.Editor</code>方法是实现：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> instances <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


        <span class="token constant">UE</span><span class="token punctuation">.</span>ui<span class="token punctuation">.</span><span class="token function-variable function">Editor</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UE<span class="token punctuation">.</span>Editor</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>editor <span class="token operator">=</span> editor<span class="token punctuation">;</span>
            utils<span class="token punctuation">.</span><span class="token function">loadFile</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                href<span class="token operator">:</span> editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>themePath <span class="token operator">+</span> editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>theme <span class="token operator">+</span> <span class="token string">'/css/ueditor.css?v='</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                tag<span class="token operator">:</span> <span class="token string">'link'</span><span class="token punctuation">,</span>
                type<span class="token operator">:</span> <span class="token string">'text/css'</span><span class="token punctuation">,</span>
                rel<span class="token operator">:</span> <span class="token string">'stylesheet'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> oldRender <span class="token operator">=</span> editor<span class="token punctuation">.</span>render<span class="token punctuation">;</span>
            editor<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">holder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span>constructor <span class="token operator">===</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    editor<span class="token punctuation">.</span>key <span class="token operator">=</span> holder<span class="token punctuation">;</span>
                    instances<span class="token punctuation">[</span>holder<span class="token punctuation">]</span> <span class="token operator">=</span> editor<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                utils<span class="token punctuation">.</span><span class="token function">domReady</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    editor<span class="token punctuation">.</span>langIsReady <span class="token operator">?</span> <span class="token function">renderUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'langReady'</span><span class="token punctuation">,</span> renderUI<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">function</span> <span class="token function">renderUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        editor<span class="token punctuation">.</span><span class="token function">setOpt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            labelMap<span class="token operator">:</span> editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>labelMap <span class="token operator">||</span> editor<span class="token punctuation">.</span><span class="token function">getLang</span><span class="token punctuation">(</span><span class="token string">'labelMap'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">new</span> <span class="token class-name">EditorUI</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span>constructor <span class="token operator">===</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                holder <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            holder <span class="token operator">&amp;&amp;</span> holder<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>textarea <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">script|textarea</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">var</span> newDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                holder<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>newDiv<span class="token punctuation">,</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">var</span> cont <span class="token operator">=</span> holder<span class="token punctuation">.</span>value <span class="token operator">||</span> holder<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
                                editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>initialContent <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[\t\r\n ]*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>cont<span class="token punctuation">)</span> <span class="token operator">?</span> editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>initialContent <span class="token operator">:</span>
                                    cont<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&gt;[\n\r\t]+([ ]{4})+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\n\r\t]+([ ]{4})+&lt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&gt;[\n\r\t]+&lt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'&gt;&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                holder<span class="token punctuation">.</span>className <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>newDiv<span class="token punctuation">.</span>className <span class="token operator">=</span> holder<span class="token punctuation">.</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                holder<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>newDiv<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> holder<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">textarea</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    editor<span class="token punctuation">.</span>textarea <span class="token operator">=</span> holder<span class="token punctuation">;</span>
                                    editor<span class="token punctuation">.</span>textarea<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span><span class="token punctuation">;</span>


                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    holder<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>


                                <span class="token punctuation">}</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    newDiv<span class="token punctuation">.</span>id <span class="token operator">=</span> holder<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
                                    domUtils<span class="token punctuation">.</span><span class="token function">removeAttributes</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                holder <span class="token operator">=</span> newDiv<span class="token punctuation">;</span>
                                holder<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span>
                        domUtils<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> <span class="token string">'edui-'</span> <span class="token operator">+</span> editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        editor<span class="token punctuation">.</span>ui<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">var</span> opt <span class="token operator">=</span> editor<span class="token punctuation">.</span>options<span class="token punctuation">;</span>
                        <span class="token comment">//给实例添加一个编辑器的容器引用</span>
                        editor<span class="token punctuation">.</span>container <span class="token operator">=</span> editor<span class="token punctuation">.</span>ui<span class="token punctuation">.</span><span class="token function">getDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">var</span> parents <span class="token operator">=</span> domUtils<span class="token punctuation">.</span><span class="token function">findParents</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">var</span> displays <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ci<span class="token punctuation">;</span> ci <span class="token operator">=</span> parents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            displays<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> ci<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display<span class="token punctuation">;</span>
                            ci<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'block'</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>initialFrameWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            opt<span class="token punctuation">.</span>minFrameWidth <span class="token operator">=</span> opt<span class="token punctuation">.</span>initialFrameWidth<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            opt<span class="token punctuation">.</span>minFrameWidth <span class="token operator">=</span> opt<span class="token punctuation">.</span>initialFrameWidth <span class="token operator">=</span> holder<span class="token punctuation">.</span>offsetWidth<span class="token punctuation">;</span>
                            <span class="token keyword">var</span> styleWidth <span class="token operator">=</span> holder<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>styleWidth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                opt<span class="token punctuation">.</span>initialFrameWidth <span class="token operator">=</span> styleWidth<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>opt<span class="token punctuation">.</span>initialFrameHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            opt<span class="token punctuation">.</span>minFrameHeight <span class="token operator">=</span> opt<span class="token punctuation">.</span>initialFrameHeight<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            opt<span class="token punctuation">.</span>initialFrameHeight <span class="token operator">=</span> opt<span class="token punctuation">.</span>minFrameHeight <span class="token operator">=</span> holder<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ci<span class="token punctuation">;</span> ci <span class="token operator">=</span> parents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ci<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> displays<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">//编辑器最外容器设置了高度，会导致，编辑器不占位</span>
                        <span class="token comment">//todo 先去掉，没有找到原因</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            holder<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        editor<span class="token punctuation">.</span>container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> opt<span class="token punctuation">.</span>initialFrameWidth <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>opt<span class="token punctuation">.</span>initialFrameWidth<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> <span class="token string">'px'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        editor<span class="token punctuation">.</span>container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>zIndex <span class="token operator">=</span> opt<span class="token punctuation">.</span>zIndex<span class="token punctuation">;</span>
                        <span class="token function">oldRender</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> editor<span class="token punctuation">.</span>ui<span class="token punctuation">.</span><span class="token function">getDom</span><span class="token punctuation">(</span><span class="token string">'iframeholder'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        editor<span class="token punctuation">.</span><span class="token function">fireEvent</span><span class="token punctuation">(</span><span class="token string">'afteruiready'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> editor<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><p>差不多一百行代码，做了以下几件事：</p> <ol><li><code>new</code> 了一个 <code>UE.Editor</code>编辑器实例 ，传入了配置项</li> <li>加载主题样式文件</li> <li>缓存该实例默认的渲染方法</li> <li>重写该编辑器实例渲染方法</li> <li>返回编辑器实例</li></ol> <p>其它的没什么可说的，我们看下它为什么要重写渲染方法，以及渲染方法都做了什么</p> <ol><li><p>渲染方法接收了一个<code>holder</code>参数，其实就是我们前面说的容器ID，所以编辑器先以将该ID设置成了编辑器的<code>key</code>，并且将编辑器存入了实例存储对象（<code>instances</code>）</p></li> <li><p>当浏览器DOM渲染加载完毕后，因为语言包配置可能是从后台异步加载，所以要先判断编辑器语言包是否就绪，如果就绪就执行编辑器渲染，如果没有就绪，则监听语言包就绪的事件，监听到就绪后执行渲染。</p></li> <li><p>新建了一个编辑器界面实例（<code>new EditorUI</code>），然后拿到了容器，检查了容器是否为<code>script</code>或<code>textarea</code>标签，如果是，在新建一个<code>div</code>容器，将<code>holder</code>容器的类名和<code>CSS</code>样式复制到新建的<code>div</code>容器上。如果<code>holder</code>容器是个<code>textarea</code>，就将它隐藏掉，如果不是，就直接移除。</p></li> <li><p>如果<code>holder</code>容器有<code>id</code>属性，将它的值赋给新的<code>div</code>容器，并且删除<code>holder</code>的<code>id</code>属性，以保证<code>id</code>的唯一性。</p></li> <li><p>将新的<code>div</code>容器作为新的<code>holder</code>容器使用。</p></li> <li><p>为容器增加主题类名</p></li> <li><p>将新容器渲染到页面中</p></li> <li><p>给实例添加一个编辑器的容器引用</p></li> <li><p>查找容器的所有祖先节点，缓存他们的<code>display</code>值，并将他们的<code>display</code>都设置为<code>block</code>， 避免初始化宽高时外层容器隐藏导致编辑器宽的<code>offsetWidth</code>和<code>offsetHeight</code>获取不准确</p></li> <li><p>为容器设置初始宽高</p></li> <li><p>恢复祖先元素的<code>display</code>值</p></li> <li><p>如果容器自身设置了高度，则去掉，否则编辑器不占位</p></li> <li><p>为容器设置宽高和显示层级</p></li> <li><p>使用缓存的渲染方法，渲染<code>iframeholder</code>容器。</p></li> <li><p>触发<code>afteruiready</code>事件。</p></li></ol> <p>那我们可能会好奇，这个<code>iframeholder</code>是怎么来的呢？</p> <p>实际上是在新建编辑器界面实例时创建的，我们看下 <code>EditorUI</code>构造方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">EditorUI</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initOptions</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initEditorUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里也是调用了两个方法:</p> <ul><li>初始化<code>UI</code>配置</li> <li>初始化<code>UI</code>界面</li></ul> <p><code>initOptions</code>方法是<code>UIBase</code>类的原型方法，看一下实现：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">initOptions</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> me <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token keyword">in</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    me<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">||</span> <span class="token string">'edui'</span> <span class="token operator">+</span> uiUtils<span class="token punctuation">.</span><span class="token function">uid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>实现很简单，实际上就是将<code>this</code>赋值给<code>me</code>，然后将传入的配置项全部赋值到<code>me</code>对象上，然后生成了当前<code>UI</code>的唯一ID</p> <h3 id="初始化编辑器ui"><a href="#初始化编辑器ui" class="header-anchor">#</a> 初始化编辑器UI</h3> <p><code>initEditorUi</code>方法是<code>EditorUI</code>类的原型方法，看下实现</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">initEditorUI</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">.</span>ui <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_dialogs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initUIBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initToolbars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> editor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>editor<span class="token punctuation">,</span>
                    me <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

                editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'delcells'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">var</span> pastePop<span class="token punctuation">,</span> isPaste <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    timer<span class="token punctuation">;</span>
                editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'afterpaste'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'afterinserthtml'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'contextmenu'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    baidu<span class="token punctuation">.</span>editor<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>Popup<span class="token punctuation">.</span><span class="token function">postHide</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'wordcount'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> me<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">function</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token parameter">editor<span class="token punctuation">,</span> ui</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   
                <span class="token punctuation">}</span>

                editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'selectionchange'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">var</span> popup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">baidu<span class="token punctuation">.</span>editor<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>Popup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                popup<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>imagePopup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'mouseover'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    editor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'selectionchange'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">t<span class="token punctuation">,</span> causeByUi</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>它做了这些事：</p> <ol><li>将当前对象赋值给当前编辑器实例的<code>ui</code>对象</li> <li>定义对话框对象</li> <li>初始化基础<code>UI</code></li> <li>初始化编辑器实例的工具条</li> <li>增加一系列事件监听：
<ul><li><code>ready</code>： 编辑器加载完成</li> <li><code>mousedown</code>: 鼠标按下</li> <li><code>delcells</code>: 删除单元格</li> <li><code>afterpaste</code>: 粘贴后</li> <li><code>afterinserthtml</code>: 插入<code>html</code>后</li> <li><code>contextmenu</code>: 触发右键菜单后</li> <li><code>keydown</code> : 键盘按下</li> <li><code>wordcount</code>: 统计字体</li> <li><code>selectionchange</code> ： 选区改变</li></ul></li> <li>定义弹出窗对象</li> <li>渲染弹窗</li> <li>如果配置了图片弹窗，则设置图片弹窗里的监听
<ul><li><code>mouseover</code>: 鼠标划过</li> <li><code>selectionchange</code>: 选区内容改变</li></ul></li></ol> <p>这其中比较重要的，是初始化基础<code>UI</code>和初始化工具条，我们分别看一下：</p> <p><code>initUIBase</code> 是<code>UIBase</code>类的原型方法，实现只有一句话：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token keyword">this</span><span class="token punctuation">.</span>_globalKey <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">unhtml</span><span class="token punctuation">(</span>uiUtils<span class="token punctuation">.</span><span class="token function">setGlobal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里，<code>setGlobal</code>会将第二个参数传入的对象设置到全局对象<code>root</code>上，键名是第一个参数，然后返回访问该对象的<code>key</code>。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">setGlobal</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">return</span> magic <span class="token operator">+</span> <span class="token string">'[&quot;'</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">'&quot;]'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>为什么返回的<code>key</code>是一个<code>magic</code>对象成员访问的形式呢，看看<code>root</code>的定义就知道了：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> magic <span class="token operator">=</span> <span class="token string">'$EDITORUI'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> root <span class="token operator">=</span> window<span class="token punctuation">[</span>magic<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在我们应该可以明白了，<code>root</code>就是挂载在window对象上的对象 <code>magic</code>, 我们实际上将当前实例（<code>this</code>）挂载到了<code>magic</code>上，所以访问时只需要使用<code>magic</code>的成员访问形式就可以访问到当前实例了。</p> <p>最后，我们得到的当前实例的全局访问<code>key</code>（<code>this._globalKey</code>）是经过<code>unhtml</code>方法转义过后的形式为<code>magin[id]</code>的字符串，实际上就是<code>window[$EDITORUI]</code>[id]。</p> <h3 id="工具条初始化"><a href="#工具条初始化" class="header-anchor">#</a> 工具条初始化</h3> <p>回过头，我们再看初始化工具条的方法 <code>_initToolbars</code>， 它就是<code>EditorUI</code>类的原型方法</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> _initToolbars: function() {
                var editor = this.editor;
                var toolbars = this.toolbars || [];
                var toolbarUis = [];
                for (var i = 0; i &lt; toolbars.length; i++) {
                    // do Some thing 
                }

                //接受外部定制的UI

                utils.each(UE._customizeUI, function(obj, key) {
                    var itemUI, index;
                    if (obj.id &amp;&amp; obj.id != editor.key) {
                        return false;
                    }
                    itemUI = obj.execFn.call(editor, editor, key);
                    if (itemUI) {
                        index = obj.index;
                        if (index === undefined) {
                            index = toolbarUi.items.length;
                        }
                        toolbarUi.add(itemUI, index);
                    }
                });

                this.toolbars = toolbarUis;
            },
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>我们看它做了哪些事：</p> <ol><li>获得当前编辑器实例</li> <li>获取工具条（是个数组）</li> <li>定义工具的<code>UI</code> (也是个数组)</li> <li>遍历工具条数组，处理每一个工具</li> <li>接受外部定制的<code>UI</code></li> <li>将工具<code>UI</code>数组作为工具条</li></ol> <p>这里面第4、5步比较重要。</p> <p>先看第4步：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> toolbar <span class="token operator">=</span> toolbars<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> toolbarUi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">baidu<span class="token punctuation">.</span>editor<span class="token punctuation">.</span>ui<span class="token punctuation">.</span>Toolbar</span><span class="token punctuation">(</span><span class="token punctuation">{</span> theme<span class="token operator">:</span> editor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>theme <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> toolbar<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> toolbarItem <span class="token operator">=</span> toolbar<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> toolbarItemUi <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> toolbarItem <span class="token operator">==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        toolbarItem <span class="token operator">=</span> toolbarItem<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>toolbarItem <span class="token operator">==</span> <span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            toolbarItem <span class="token operator">=</span> <span class="token string">'Separator'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>toolbarItem <span class="token operator">==</span> <span class="token string">'||'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            toolbarItem <span class="token operator">=</span> <span class="token string">'Breakline'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>baidu<span class="token punctuation">.</span>editor<span class="token punctuation">.</span>ui<span class="token punctuation">[</span>toolbarItem<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            toolbarItemUi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">baidu<span class="token punctuation">.</span>editor<span class="token punctuation">.</span>ui</span><span class="token punctuation">[</span>toolbarItem<span class="token punctuation">]</span><span class="token punctuation">(</span>editor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//fullscreen这里单独处理一下，放到首行去</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>toolbarItem <span class="token operator">==</span> <span class="token string">'fullscreen'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>toolbarUis <span class="token operator">&amp;&amp;</span> toolbarUis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                toolbarUis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> toolbarItemUi<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                toolbarItemUi <span class="token operator">&amp;&amp;</span> toolbarUi<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> toolbarItemUi<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    	toolbarItemUi <span class="token operator">=</span> toolbarItem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>toolbarItemUi <span class="token operator">&amp;&amp;</span> toolbarItemUi<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        toolbarUi<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>toolbarItemUi<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
toolbarUis<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> toolbarUi<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><ol><li>取得当前工具条，这里一个工具条其实就是一行工具按钮，最终界面上有几行工具按钮，就有几个工具条。</li> <li>新建一个工具<code>UI</code></li> <li>遍历当前这一行工具条中的所有工具名，进行如下处理
<ol><li>如果当前工具名是字符串类型，则将它转为全小写，做如下处理
<ol><li>如果是<code>|</code> ，则是分割符</li> <li>如果是<code>||</code>， 则是换行符</li> <li>如果当前编辑器实例的<code>ui</code>对象上有该工具同名的方法，则使用该方法实例化一个该类工具出来</li> <li>如果当前工具名为<code>fullscrenn</code>（全屏）, 单独处理，放到首行去</li></ol></li> <li>如果不是字符串类型，说明是对象或数组，则当前工具的<code>UI</code>就被赋值为当前工具</li> <li>如果此时当前工具<code>UI</code>存在并且具有<code>id</code> 属性，则将当前工具添加到当前这一行工具条<code>UI</code>中</li></ol></li> <li>将当前行的工具条<code>UI</code>添加到整个工具条<code>UI</code>中</li></ol> <p>然后看第5步：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>utils<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token constant">UE</span><span class="token punctuation">.</span>_customizeUI<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> itemUI<span class="token punctuation">,</span> index<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>id <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>id <span class="token operator">!=</span> editor<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    itemUI <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">execFn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>editor<span class="token punctuation">,</span> editor<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>itemUI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        index <span class="token operator">=</span> obj<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index <span class="token operator">=</span> toolbarUi<span class="token punctuation">.</span>items<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        toolbarUi<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>itemUI<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这一步遍历了<code>UE._customizeUI</code>对象中的所有对象，将他们作为<code>UI</code>对象添加到了工具条中。</p> <p><code>UE</code>提供了 <code>UE.registerUI</code>方法，使得我们可以在二次开发时定制增加自己的工具到工具条中，实际上这个方法就是将我们提供的工具放在了<code>UE._custoomizeUI</code>对象中，然后在这里将它们添加到了工具条中。</p> <p>这里首先判断了当前对象是否是注册在当前实例上的，如果不是，则中断执行。如果是，则让当前编辑器实例调用我们设定的执行方法生成它的<code>UI</code>， 然后将它插入到工具条中，这里的<code>index</code>参数是注册时传入的，可以定义插入的位置。</p> <h3 id="render方法"><a href="#render方法" class="header-anchor">#</a> render方法</h3> <p>现在我们再回过头来看<code>Editor</code>构造方法里的第14步： 使用缓存的渲染方法渲染<code>iframeholder</code>这一步，那我们就很好奇，这个缓存下的渲染方法是什么样的呢？</p> <p>我们在<code>Editor.prototype</code>对象里找到了它：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token comment">/**
 * 渲染编辑器的DOM到指定容器
 * @method render
 * @param { Element } containerDom 直接指定容器对象
 * @remind 执行该方法,会触发ready事件
 * @warning 必须且只能调用一次
 */</span>
<span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//... </span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在这个方法中，先是获取了当前编辑器实例和配置，并且定义了一个获取dom样式的方法：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token keyword">var</span> me <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
 options <span class="token operator">=</span> me<span class="token punctuation">.</span>options<span class="token punctuation">,</span>
 <span class="token function-variable function">getStyleValue</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>domUtils<span class="token punctuation">.</span><span class="token function">getComputedStyle</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> attr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果传入的容器参数是字符串，则以此为<code>id</code>获取容器真实元素：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">isString</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果元素存在于页面，则根据元素的布局宽高（包含padding和border，不包含margin）设置元素的宽高，最终的宽高要减去元素当前的padding。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>initialFrameWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>minFrameWidth <span class="token operator">=</span> options<span class="token punctuation">.</span>initialFrameWidth<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>minFrameWidth <span class="token operator">=</span> options<span class="token punctuation">.</span>initialFrameWidth <span class="token operator">=</span> container<span class="token punctuation">.</span>offsetWidth<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>initialFrameHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>minFrameHeight <span class="token operator">=</span> options<span class="token punctuation">.</span>initialFrameHeight<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>initialFrameHeight <span class="token operator">=</span> options<span class="token punctuation">.</span>minFrameHeight <span class="token operator">=</span> container<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>initialFrameWidth<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'100%'</span> <span class="token operator">:</span> options<span class="token punctuation">.</span>initialFrameWidth <span class="token operator">-</span>
        <span class="token function">getStyleValue</span><span class="token punctuation">(</span><span class="token string">'padding-left'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">getStyleValue</span><span class="token punctuation">(</span><span class="token string">'padding-right'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
    container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>initialFrameHeight<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'100%'</span> <span class="token operator">:</span> options<span class="token punctuation">.</span>initialFrameHeight <span class="token operator">-</span>
        <span class="token function">getStyleValue</span><span class="token punctuation">(</span><span class="token string">'padding-top'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">getStyleValue</span><span class="token punctuation">(</span><span class="token string">'padding-bottom'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>

    container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>zIndex <span class="token operator">=</span> options<span class="token punctuation">.</span>zIndex<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>创建编辑器的<code>html</code>代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token punctuation">(</span>ie <span class="token operator">&amp;&amp;</span> browser<span class="token punctuation">.</span>version <span class="token operator">&lt;</span> <span class="token number">9</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> <span class="token string">'&lt;!DOCTYPE html&gt;'</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token string">'&lt;html xmlns=\'http://www.w3.org/1999/xhtml\' class=\'view\' &gt;&lt;head&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;style type=\'text/css\'&gt;'</span> <span class="token operator">+</span>
            <span class="token comment">//设置四周的留边</span>
            <span class="token string">'.view{padding:0;word-wrap:break-word;cursor:text;height:90%;overflow:hidden}\n'</span><span class="token punctuation">;</span>
        <span class="token comment">//设置默认字体和字号</span>
        <span class="token comment">//font-family不能呢随便改，在safari下fillchar会有解析问题</span>
         html <span class="token operator">+=</span> <span class="token string">'body{margin:28px;font-family:宋体,SimSun;font-size:16px;}'</span><span class="token punctuation">;</span>
        <span class="token comment">//设置段落间距</span>
        html <span class="token operator">+=</span> <span class="token string">'p{margin:5px 0;}&lt;/style&gt;'</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span>options<span class="token punctuation">.</span>iframeCssUrl <span class="token operator">?</span> <span class="token string">'&lt;link rel=\'stylesheet\' type=\'text/css\' href=\''</span> <span class="token operator">+</span> utils<span class="token punctuation">.</span><span class="token function">unhtml</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>iframeCssUrl<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\'/&gt;'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span>options<span class="token punctuation">.</span>initialStyle <span class="token operator">?</span> <span class="token string">'&lt;style&gt;'</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>initialStyle <span class="token operator">+</span> <span class="token string">'&lt;/style&gt;'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token string">'&lt;/head&gt;&lt;body class=\'view\' &gt;&lt;/body&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;script type=\'text/javascript\' '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ie <span class="token operator">?</span> <span class="token string">'defer=\'defer\''</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' id=\'_initialScript\'&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'setTimeout(function(){editor = window.parent.UE.instants[\'ueditorInstant'</span> <span class="token operator">+</span> me<span class="token punctuation">.</span>uid <span class="token operator">+</span> <span class="token string">'\'];editor._setup(document);},0);'</span> <span class="token operator">+</span>
            <span class="token string">'var _tmpScript = document.getElementById(\'_initialScript\');_tmpScript.parentNode.removeChild(_tmpScript);&lt;/script&gt;&lt;/html&gt;'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>这里面，要注意</p> <ul><li>IE的9以下版本需要去掉<code>iframe</code>中页面的<code>DOCTYPE</code>头才能让<code>iframe</code>里的内容正常显示</li></ul> <p>然后就是将创建<code>iframe</code>并将<code>html</code>放入<code>iframe</code>中，并且设置超出隐藏：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>domUtils<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token string">'iframe'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token string">'ueditor_'</span> <span class="token operator">+</span> me<span class="token punctuation">.</span>uid<span class="token punctuation">,</span>
    width<span class="token operator">:</span> <span class="token string">'100%'</span><span class="token punctuation">,</span>
    height<span class="token operator">:</span> <span class="token string">'100%'</span><span class="token punctuation">,</span>
    frameborder<span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
    <span class="token comment">//先注释掉了，加的原因忘记了，但开启会直接导致全屏模式下内容多时不会出现滚动条</span>
    <span class="token comment">//scrolling :'no',</span>
    src<span class="token operator">:</span> <span class="token string">'javascript:void(function(){document.open();'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>customDomain <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span>domain <span class="token operator">!=</span> location<span class="token punctuation">.</span>hostname <span class="token operator">?</span> <span class="token string">'document.domain=&quot;'</span> <span class="token operator">+</span> document<span class="token punctuation">.</span>domain <span class="token operator">+</span> <span class="token string">'&quot;;'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span>
    <span class="token string">'document.write(&quot;'</span> <span class="token operator">+</span> html <span class="token operator">+</span> <span class="token string">'&quot;);document.close();}())'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflow <span class="token operator">=</span> <span class="token string">'hidden'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>最后，设置了一个延时执行函数，来处理给定百分比时高度算不对的问题：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//解决如果是给定的百分比，会导致高度算不对的问题</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>initialFrameWidth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>minFrameWidth <span class="token operator">=</span> options<span class="token punctuation">.</span>initialFrameWidth <span class="token operator">=</span> container<span class="token punctuation">.</span>offsetWidth<span class="token punctuation">;</span>
        <span class="token comment">//如果这里给定宽度，会导致ie在拖动窗口大小时，编辑区域不随着变化</span>
        <span class="token comment">//  container.style.width = options.initialFrameWidth + 'px';</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>initialFrameHeight<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>minFrameHeight <span class="token operator">=</span> options<span class="token punctuation">.</span>initialFrameHeight <span class="token operator">=</span> container<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">;</span>
        container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> options<span class="token punctuation">.</span>initialFrameHeight <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></div></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cd8205c8.js" defer></script><script src="/assets/js/11.4c288b74.js" defer></script><script src="/assets/js/117.e5957144.js" defer></script>
  </body>
</html>
