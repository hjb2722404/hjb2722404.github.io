<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ueditor源码分析——默认插件与命令实现解析 | 林中路</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="
粘贴：paste

调用方式：

ueditor.exceCommand('paste')

实现分析

UE.plugins['paste'] = function () {
    function getClipboardData(callback){
        //...
    }
 ...">
    
    <link rel="preload" href="/assets/css/0.styles.6d0d6f13.css" as="style"><link rel="preload" href="/assets/js/app.cd8205c8.js" as="script"><link rel="preload" href="/assets/js/11.4c288b74.js" as="script"><link rel="preload" href="/assets/js/121.7d55e294.js" as="script"><link rel="prefetch" href="/assets/js/1.c492b4cd.js"><link rel="prefetch" href="/assets/js/10.5c791580.js"><link rel="prefetch" href="/assets/js/100.98ff7760.js"><link rel="prefetch" href="/assets/js/101.e5cd16d7.js"><link rel="prefetch" href="/assets/js/102.cc9bc85b.js"><link rel="prefetch" href="/assets/js/103.7b07b598.js"><link rel="prefetch" href="/assets/js/104.ee58d457.js"><link rel="prefetch" href="/assets/js/105.48c57f25.js"><link rel="prefetch" href="/assets/js/106.b702757c.js"><link rel="prefetch" href="/assets/js/107.8122f1ef.js"><link rel="prefetch" href="/assets/js/108.51e66dbe.js"><link rel="prefetch" href="/assets/js/109.3145253b.js"><link rel="prefetch" href="/assets/js/110.f9990065.js"><link rel="prefetch" href="/assets/js/111.3263bd3f.js"><link rel="prefetch" href="/assets/js/112.9071b5e2.js"><link rel="prefetch" href="/assets/js/113.f131242e.js"><link rel="prefetch" href="/assets/js/114.7a6e09f7.js"><link rel="prefetch" href="/assets/js/115.508d99ac.js"><link rel="prefetch" href="/assets/js/116.f4900a92.js"><link rel="prefetch" href="/assets/js/117.e5957144.js"><link rel="prefetch" href="/assets/js/118.062eb3c1.js"><link rel="prefetch" href="/assets/js/119.93634bcc.js"><link rel="prefetch" href="/assets/js/12.c3b16095.js"><link rel="prefetch" href="/assets/js/120.1bada0ab.js"><link rel="prefetch" href="/assets/js/122.b7f7c837.js"><link rel="prefetch" href="/assets/js/123.3a0b4694.js"><link rel="prefetch" href="/assets/js/124.bd458b77.js"><link rel="prefetch" href="/assets/js/125.8ca612c9.js"><link rel="prefetch" href="/assets/js/126.35bccb3e.js"><link rel="prefetch" href="/assets/js/127.9b3097f5.js"><link rel="prefetch" href="/assets/js/128.5833cf40.js"><link rel="prefetch" href="/assets/js/129.38ec9907.js"><link rel="prefetch" href="/assets/js/13.91404f5a.js"><link rel="prefetch" href="/assets/js/130.932a54c4.js"><link rel="prefetch" href="/assets/js/131.f4ab894a.js"><link rel="prefetch" href="/assets/js/14.ef93462f.js"><link rel="prefetch" href="/assets/js/15.83829c35.js"><link rel="prefetch" href="/assets/js/16.d245c760.js"><link rel="prefetch" href="/assets/js/17.4a9f3c99.js"><link rel="prefetch" href="/assets/js/18.75ce45c7.js"><link rel="prefetch" href="/assets/js/19.b86d35ae.js"><link rel="prefetch" href="/assets/js/20.9657eb2e.js"><link rel="prefetch" href="/assets/js/21.f89cf353.js"><link rel="prefetch" href="/assets/js/22.746aec5f.js"><link rel="prefetch" href="/assets/js/23.ca2ee980.js"><link rel="prefetch" href="/assets/js/24.e1eeb0f4.js"><link rel="prefetch" href="/assets/js/25.f96e0147.js"><link rel="prefetch" href="/assets/js/26.cc4cf83e.js"><link rel="prefetch" href="/assets/js/27.f940e542.js"><link rel="prefetch" href="/assets/js/28.99771a3c.js"><link rel="prefetch" href="/assets/js/29.841b64b0.js"><link rel="prefetch" href="/assets/js/30.772e1ff4.js"><link rel="prefetch" href="/assets/js/31.7e0b62c5.js"><link rel="prefetch" href="/assets/js/32.cf3d5fb6.js"><link rel="prefetch" href="/assets/js/33.b338e29a.js"><link rel="prefetch" href="/assets/js/34.8b8356fe.js"><link rel="prefetch" href="/assets/js/35.1b12a1f7.js"><link rel="prefetch" href="/assets/js/36.547e2f8d.js"><link rel="prefetch" href="/assets/js/37.36a240bd.js"><link rel="prefetch" href="/assets/js/38.4f6b92e3.js"><link rel="prefetch" href="/assets/js/39.5133d0dd.js"><link rel="prefetch" href="/assets/js/4.524efd0b.js"><link rel="prefetch" href="/assets/js/40.8c765af6.js"><link rel="prefetch" href="/assets/js/41.b7234e21.js"><link rel="prefetch" href="/assets/js/42.b5ac212a.js"><link rel="prefetch" href="/assets/js/43.5d1b3b6c.js"><link rel="prefetch" href="/assets/js/44.eda633f8.js"><link rel="prefetch" href="/assets/js/45.39f5263b.js"><link rel="prefetch" href="/assets/js/46.f1fbfada.js"><link rel="prefetch" href="/assets/js/47.ed969447.js"><link rel="prefetch" href="/assets/js/48.e1867366.js"><link rel="prefetch" href="/assets/js/49.c2a4bc6b.js"><link rel="prefetch" href="/assets/js/5.a180cf14.js"><link rel="prefetch" href="/assets/js/50.da77d6a3.js"><link rel="prefetch" href="/assets/js/51.4183e6ab.js"><link rel="prefetch" href="/assets/js/52.b18add11.js"><link rel="prefetch" href="/assets/js/53.08c1d448.js"><link rel="prefetch" href="/assets/js/54.9edeb19b.js"><link rel="prefetch" href="/assets/js/55.9a3ed63e.js"><link rel="prefetch" href="/assets/js/56.dcf34dca.js"><link rel="prefetch" href="/assets/js/57.2123aa49.js"><link rel="prefetch" href="/assets/js/58.c9833b3b.js"><link rel="prefetch" href="/assets/js/59.8da7c174.js"><link rel="prefetch" href="/assets/js/6.529edc8a.js"><link rel="prefetch" href="/assets/js/60.9a70415e.js"><link rel="prefetch" href="/assets/js/61.35935df8.js"><link rel="prefetch" href="/assets/js/62.0e63cfe7.js"><link rel="prefetch" href="/assets/js/63.a52d5a72.js"><link rel="prefetch" href="/assets/js/64.cf7dfcc7.js"><link rel="prefetch" href="/assets/js/65.0220a5ee.js"><link rel="prefetch" href="/assets/js/66.5cd774f3.js"><link rel="prefetch" href="/assets/js/67.d8943555.js"><link rel="prefetch" href="/assets/js/68.7cf24f78.js"><link rel="prefetch" href="/assets/js/69.56501738.js"><link rel="prefetch" href="/assets/js/7.ac95b826.js"><link rel="prefetch" href="/assets/js/70.9626260f.js"><link rel="prefetch" href="/assets/js/71.a466c6f1.js"><link rel="prefetch" href="/assets/js/72.0a678f77.js"><link rel="prefetch" href="/assets/js/73.597ea695.js"><link rel="prefetch" href="/assets/js/74.a0387d5c.js"><link rel="prefetch" href="/assets/js/75.97871f2e.js"><link rel="prefetch" href="/assets/js/76.7d8e44c7.js"><link rel="prefetch" href="/assets/js/77.b53c8e31.js"><link rel="prefetch" href="/assets/js/78.9fef1461.js"><link rel="prefetch" href="/assets/js/79.9af76496.js"><link rel="prefetch" href="/assets/js/8.6bb76bea.js"><link rel="prefetch" href="/assets/js/80.5f7ee3db.js"><link rel="prefetch" href="/assets/js/81.1937e784.js"><link rel="prefetch" href="/assets/js/82.2bdeb675.js"><link rel="prefetch" href="/assets/js/83.e04a8620.js"><link rel="prefetch" href="/assets/js/84.ca8713d0.js"><link rel="prefetch" href="/assets/js/85.40f655ff.js"><link rel="prefetch" href="/assets/js/86.87397155.js"><link rel="prefetch" href="/assets/js/87.798cdf26.js"><link rel="prefetch" href="/assets/js/88.e089f692.js"><link rel="prefetch" href="/assets/js/89.5d842e18.js"><link rel="prefetch" href="/assets/js/9.5b2ac283.js"><link rel="prefetch" href="/assets/js/90.4157be98.js"><link rel="prefetch" href="/assets/js/91.7ed6afe7.js"><link rel="prefetch" href="/assets/js/92.9c50ce3b.js"><link rel="prefetch" href="/assets/js/93.e8e16a70.js"><link rel="prefetch" href="/assets/js/94.cf98a377.js"><link rel="prefetch" href="/assets/js/95.a4b78938.js"><link rel="prefetch" href="/assets/js/96.a7a9f018.js"><link rel="prefetch" href="/assets/js/97.f96c42c9.js"><link rel="prefetch" href="/assets/js/98.ce7378e5.js"><link rel="prefetch" href="/assets/js/99.24959418.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.706cf0ce.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6d0d6f13.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="header"><div class="blog-info" data-v-54e0dde5>
   林中路
   <p data-v-54e0dde5>少有人走的路，逐渐向世界显现</p></div> <div class="blog-author-info" data-v-51bc2051><p class="author-head-img" data-v-51bc2051><img src="/assets/img/head-img.8e2d0100.png" alt data-v-51bc2051></p></div> <div class="blog-category-list" data-v-581efa6b><ul data-v-581efa6b></ul></div></div> <div class="content"><div class="template-container" data-v-b70586ba><div class="content" data-v-b70586ba><div class="content__default" data-v-b70586ba><h1 id="ueditor源码分析-默认插件与命令实现解析"><a href="#ueditor源码分析-默认插件与命令实现解析" class="header-anchor">#</a> Ueditor源码分析——默认插件与命令实现解析</h1> <h2 id="粘贴-paste"><a href="#粘贴-paste" class="header-anchor">#</a> 粘贴：paste</h2> <h3 id="调用方式"><a href="#调用方式" class="header-anchor">#</a> 调用方式：</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>ueditor<span class="token punctuation">.</span><span class="token function">exceCommand</span><span class="token punctuation">(</span><span class="token string">'paste'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="实现分析"><a href="#实现分析" class="header-anchor">#</a> 实现分析</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token constant">UE</span><span class="token punctuation">.</span>plugins<span class="token punctuation">[</span><span class="token string">'paste'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">getClipboardData</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> me <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    me<span class="token punctuation">.</span><span class="token function">setOpt</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">//...});</span>
    <span class="token keyword">var</span> tXtContent<span class="token punctuation">,</span> htmlContent<span class="token punctuation">,</span> address<span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">getPureHtml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//...}</span>
    <span class="token keyword">function</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">div</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//...}</span>
    me<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'pasteTransfer'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cmd<span class="token punctuation">,</span> plainType</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//..});</span>
    me<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//...});</span>
    me<span class="token punctuation">.</span>commands<span class="token punctuation">[</span><span class="token string">'paste'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">//...}    </span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>粘贴功能是以插件方式定义的。</li> <li>在插件方法中定义了粘贴命令，作为执行粘贴操作的入口。</li> <li>定义了三个私有方法，和三个局部变量，添加了两个事件监听器。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>	me<span class="token punctuation">.</span><span class="token function">setOpt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        retainOnlyLabelPasted <span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>配置<code>retainOnlyLabelPasted</code> : 非纯文本粘贴模式下，是否净化HTML内容。</p> <p>入口：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>me<span class="token punctuation">.</span>commands<span class="token punctuation">[</span><span class="token string">'paste'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">execCommand</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">getClipboardData</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>me<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">div</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">filter</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                me<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">'paste'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">getLang</span><span class="token punctuation">(</span><span class="token string">'pastemsg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>这个入口易弃用，因为从它的逻辑看只支持IE下的粘贴操作，那真正的入口在哪呢？</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>me<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            domUtils<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token string">'cut'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> range <span class="token operator">=</span> me<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>range<span class="token punctuation">.</span>collapsed <span class="token operator">&amp;&amp;</span> me<span class="token punctuation">.</span>undoManger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    me<span class="token punctuation">.</span>undoManger<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//ie下beforepaste在点击右键时也会触发，所以用监控键盘才处理</span>
            domUtils<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span>body<span class="token punctuation">,</span> browser<span class="token punctuation">.</span>ie <span class="token operator">||</span> browser<span class="token punctuation">.</span>opera <span class="token operator">?</span> <span class="token string">'keydown'</span> <span class="token operator">:</span> <span class="token string">'paste'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>browser<span class="token punctuation">.</span>ie <span class="token operator">||</span> browser<span class="token punctuation">.</span>opera<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span>ctrlKey <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>e<span class="token punctuation">.</span>metaKey<span class="token punctuation">)</span> <span class="token operator">||</span> e<span class="token punctuation">.</span>keyCode <span class="token operator">!=</span> <span class="token string">'86'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">getClipboardData</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>me<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">div</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">filter</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>原来是在这个事件监听器中，当<code>UE</code>加载完成后，添加了两个监听，一个是在剪切时，如果当前光标所在拖蓝区域不是闭合的，就先保存好当前现场。另一个就是当监听到编辑器内容区域的粘贴事件时，就从系统剪贴板获取内容，并且对内容进行过滤后加入编辑器。</p> <p>这里面有一个兼容操作，即在<code>IE</code>下或者<code>opera</code>下，<code>beforepaste</code>在点击右键时也会触发，所以对键盘做了一个监听判断，如果按下的不是<code>ctrl+v</code>，则说明不是粘贴，就中断执行。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getClipboardData</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> doc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>document<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>doc<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'baidu_pastebin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bk <span class="token operator">=</span> range<span class="token punctuation">.</span><span class="token function">createBookmark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">//创建剪贴的容器div</span>
            pastebin <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pastebin<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'baidu_pastebin'</span><span class="token punctuation">;</span>
        <span class="token comment">// Safari 要求div必须有内容，才能粘贴内容进来</span>
        browser<span class="token punctuation">.</span>webkit <span class="token operator">&amp;&amp;</span> pastebin<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>domUtils<span class="token punctuation">.</span>fillChar <span class="token operator">+</span> domUtils<span class="token punctuation">.</span>fillChar<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        doc<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>pastebin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//trace:717 隐藏的span不能得到top</span>
        <span class="token comment">//bk.start.innerHTML = '&amp;nbsp;';</span>
        bk<span class="token punctuation">.</span>start<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        pastebin<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token string">&quot;position:absolute;width:1px;height:1px;overflow:hidden;left:-1000px;white-space:nowrap;top:&quot;</span> <span class="token operator">+</span>
            <span class="token comment">//要在现在光标平行的位置加入，否则会出现跳动的问题</span>
            domUtils<span class="token punctuation">.</span><span class="token function">getXY</span><span class="token punctuation">(</span>bk<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token string">'px'</span><span class="token punctuation">;</span>

        range<span class="token punctuation">.</span><span class="token function">selectNodeContents</span><span class="token punctuation">(</span>pastebin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>webkit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> pastebins <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'[[baidu_pastebin]]'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pi<span class="token punctuation">;</span> pi <span class="token operator">=</span> pastebins<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>domUtils<span class="token punctuation">.</span><span class="token function">isEmptyNode</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        domUtils<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        pastebin <span class="token operator">=</span> pi<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                pastebin<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>pastebin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
            range<span class="token punctuation">.</span><span class="token function">moveToBookmark</span><span class="token punctuation">(</span>bk<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>pastebin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><ol><li>先判断是否已经有了剪贴内容，避免没有执行完粘贴操作就再次粘贴</li> <li>获取当前拖蓝区域，并创建书签，以便于粘贴后的光标位置恢复</li> <li>创建粘贴容器</li> <li>设置该容器宽高都为1像素，超出内容隐藏，不断行，并且顶部位置与当前光标顶部位置平行（避免位置跳动）。</li> <li>选中粘贴容器中的内容</li> <li>移除空的粘贴容器，获取最终要粘贴的内容</li> <li>恢复光标位置，对粘贴内容进行过滤。</li></ol> <p>你可能会注意到，在上述第5步后，第6/7部实在一个延时函数里进行的：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>webkit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这个延迟函数起什么作用呢？</p> <p>其实它是把这个操作放到异步操作中，之所以如此，是因为此时需要等待程序拿到剪贴板的内容（毕竟是粘贴操作嘛）后才能执行第6/7步。</p> <p>那么，剪贴板的内容是从哪里获取的呢？搜寻源码，我们可以找到如下代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>bindEvents<span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token comment">//插入粘贴板的图片，拖放插入图片</span>
            <span class="token string">'ready'</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">var</span> me <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>FormData <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>FileReader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    domUtils<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token string">'paste drop'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">var</span> hasImg <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                            items<span class="token punctuation">;</span>
                        <span class="token comment">//获取粘贴板文件列表或者拖放文件列表</span>
                        items <span class="token operator">=</span> e<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'paste'</span> <span class="token operator">?</span> <span class="token function">getPasteImage</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">getDropImage</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            <span class="token keyword">var</span> len <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
                                file<span class="token punctuation">;</span>
                            <span class="token keyword">while</span> <span class="token punctuation">(</span>len<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                                file <span class="token operator">=</span> items<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>getAsFile<span class="token punctuation">)</span> file <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getAsFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span><span class="token punctuation">(</span>file <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token function">sendAndInsertFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> me<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    hasImg <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            hasImg <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>可以看到，在编辑器的<code>ready</code>事件里，设置了一个监听器，监听编辑器可编辑区域的<code>paste</code>和<code>drop</code>事件，这里判断如果事件类型是<code>paste</code>， 就会去获取剪贴板文件列表，看下<code>getPasteImage</code>的实现：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getPasteImage</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> e<span class="token punctuation">.</span>clipboardData <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span>items <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span>items<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^image\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span>items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">?</span> e<span class="token punctuation">.</span>clipboardData<span class="token punctuation">.</span>items<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里是利用了浏览器提供的事件对象的<code>clipboardData</code>对象，这个数据对象就是粘贴板里的内容了。</p> <p>当然，从这个方法是正则可以看出来，这个方法只是去获取剪贴板中的图片文件的。那么，如果是字符串呢？</p> <p>我们可以在<code>paste</code>事件的<code>API</code>的说明里找到下面的一段话：</p> <blockquote><p>如果光标位于可编辑的上下文中（例如，在 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/textarea" target="_blank" rel="noopener noreferrer">``<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或者 <code>contenteditable</code> 属性设置为 <code>true的元素</code>），则默认操作是将剪贴板的内容插入光标所在位置的文档中。</p></blockquote> <p>而我们看到在延迟函数前有这么一句：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>range<span class="token punctuation">.</span><span class="token function">selectNodeContents</span><span class="token punctuation">(</span>pastebin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也就是所，这一句确保当前光标所在位置是位于剪贴容器中的，而在延迟函数执行前，浏览器会将剪贴板的内容拆入这个剪贴容器中。</p> <p>所以在执行下面的过滤函数时，剪贴板的内容就已经被加入到了编辑器中。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">div</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> html<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>div<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//去掉cut中添加的边界值</span>
            <span class="token keyword">var</span> nodes <span class="token operator">=</span> domUtils<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span>div<span class="token punctuation">,</span> <span class="token string">'span'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ni<span class="token punctuation">;</span> ni <span class="token operator">=</span> nodes<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ni<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token string">'_baidu_cut_start'</span> <span class="token operator">||</span> ni<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token string">'_baidu_cut_end'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    domUtils<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ni<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>webkit<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">var</span> brs <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'div br'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> bi<span class="token punctuation">;</span> bi <span class="token operator">=</span> brs<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> pN <span class="token operator">=</span> bi<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pN<span class="token punctuation">.</span>tagName <span class="token operator">==</span> <span class="token string">'DIV'</span> <span class="token operator">&amp;&amp;</span> pN<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pN<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;p&gt;&lt;br/&gt;&lt;/p&gt;'</span><span class="token punctuation">;</span>
                        domUtils<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">var</span> divs <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'[[baidu_pastebin]]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> di<span class="token punctuation">;</span> di <span class="token operator">=</span> divs<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> tmpP <span class="token operator">=</span> me<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    di<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>tmpP<span class="token punctuation">,</span> di<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>di<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        tmpP<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>di<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    domUtils<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>di<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">var</span> metas <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'meta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ci<span class="token punctuation">;</span> ci <span class="token operator">=</span> metas<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    domUtils<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ci<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">var</span> brs <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'br'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ci <span class="token operator">=</span> brs<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^apple-</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>ci<span class="token punctuation">.</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        domUtils<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ci<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>gecko<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> dirtyNodes <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'[_moz_dirty]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ci <span class="token operator">=</span> dirtyNodes<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ci<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'_moz_dirty'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>browser<span class="token punctuation">.</span>ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> spans <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'span.Apple-style-span'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ci<span class="token punctuation">;</span> ci <span class="token operator">=</span> spans<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    domUtils<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ci<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//ie下使用innerHTML会产生多余的\r\n字符，也会产生&amp;nbsp;这里过滤掉</span>
            html <span class="token operator">=</span> div<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span><span class="token comment">//.replace(/&gt;(?:(\s|&amp;nbsp;)*?)&lt;/g,'&gt;&lt;');</span>

            <span class="token comment">//过滤word粘贴过来的冗余属性</span>
            html <span class="token operator">=</span> <span class="token constant">UE</span><span class="token punctuation">.</span><span class="token function">filterWord</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//取消了忽略空白的第二个参数，粘贴过来的有些是有空白的，会被套上相关的标签</span>
            <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token constant">UE</span><span class="token punctuation">.</span><span class="token function">htmlparser</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果给了过滤规则就先进行过滤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>me<span class="token punctuation">.</span>options<span class="token punctuation">.</span>filterRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token constant">UE</span><span class="token punctuation">.</span><span class="token function">filterNode</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> me<span class="token punctuation">.</span>options<span class="token punctuation">.</span>filterRules<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//执行默认的处理</span>
            me<span class="token punctuation">.</span><span class="token function">filterInputRule</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//针对chrome的处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>browser<span class="token punctuation">.</span>webkit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> br <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">lastChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>br <span class="token operator">&amp;&amp;</span> br<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'element'</span> <span class="token operator">&amp;&amp;</span> br<span class="token punctuation">.</span>tagName <span class="token operator">==</span> <span class="token string">'br'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    root<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>br<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                utils<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>me<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>domUtils<span class="token punctuation">.</span><span class="token function">isEmptyBlock</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        domUtils<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            html <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'html'</span><span class="token operator">:</span> root<span class="token punctuation">.</span><span class="token function">toHtml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            me<span class="token punctuation">.</span><span class="token function">fireEvent</span><span class="token punctuation">(</span><span class="token string">'beforepaste'</span><span class="token punctuation">,</span> html<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//抢了默认的粘贴，那后边的内容就不执行了，比如表格粘贴</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>html<span class="token punctuation">.</span>html<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            root <span class="token operator">=</span> <span class="token constant">UE</span><span class="token punctuation">.</span><span class="token function">htmlparser</span><span class="token punctuation">(</span>html<span class="token punctuation">.</span>html<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果开启了纯文本模式</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">queryCommandState</span><span class="token punctuation">(</span><span class="token string">'pasteplain'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                me<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">'insertHtml'</span><span class="token punctuation">,</span> <span class="token constant">UE</span><span class="token punctuation">.</span><span class="token function">filterNode</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> me<span class="token punctuation">.</span>options<span class="token punctuation">.</span>filterTxtRules<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHtml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//文本模式</span>
                <span class="token constant">UE</span><span class="token punctuation">.</span><span class="token function">filterNode</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> me<span class="token punctuation">.</span>options<span class="token punctuation">.</span>filterTxtRules<span class="token punctuation">)</span><span class="token punctuation">;</span>
                txtContent <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">toHtml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//完全模式</span>
                htmlContent <span class="token operator">=</span> html<span class="token punctuation">.</span>html<span class="token punctuation">;</span>

                address <span class="token operator">=</span> me<span class="token punctuation">.</span>selection<span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createAddress</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                me<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">'insertHtml'</span><span class="token punctuation">,</span> me<span class="token punctuation">.</span><span class="token function">getOpt</span><span class="token punctuation">(</span><span class="token string">'retainOnlyLabelPasted'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">?</span>  <span class="token function">getPureHtml</span><span class="token punctuation">(</span>htmlContent<span class="token punctuation">)</span> <span class="token operator">:</span> htmlContent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            me<span class="token punctuation">.</span><span class="token function">fireEvent</span><span class="token punctuation">(</span><span class="token string">&quot;afterpaste&quot;</span><span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br></div></div><ol><li>去掉从编辑器内剪切时增加的边界值节点</li> <li>不同浏览器处理空白节点
<ul><li>如果是<code>webkit</code>内核浏览器：</li> <li>如果是<code>gecko</code>内核浏览器</li> <li>其它非<code>ie</code>的浏览器</li></ul></li></ol></div></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cd8205c8.js" defer></script><script src="/assets/js/11.4c288b74.js" defer></script><script src="/assets/js/121.7d55e294.js" defer></script>
  </body>
</html>
